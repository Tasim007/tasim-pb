<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Hospitals</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            font-family: 'Arial', sans-serif;
            height: 100%;
        }

        /* High-resolution map */
        #map {
            width: 100%;
            height: 65vh; /* Increased map height for mobile */
        }

        /* Search container styling */
        .search-container {
            position: relative;
            z-index: 1000;
            width: 90%;
            margin: 10px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Input field */
        .search-box-wrapper {
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
        }

        /* Search box */
        .search-box {
            width: 100%;
            height: 40px;
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Clear button inside the search box */
        .clear-button {
            position: absolute;
            right: 15px;
            top: 12px;
            font-size: 18px;
            cursor: pointer;
            color: #aaa;
        }

        /* Animated search button */
        .search-button {
            padding: 12px 20px;
            margin-top: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            width: 100%;
            max-width: 150px;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease-in-out, transform 0.3s;
        }

        .search-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        /* Suggestions styling */
        .suggestions {
            position: absolute;
            top: 45px;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 999;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .suggestion {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .suggestion:hover {
            background-color: #f1f1f1;
        }

        /* Hospital information section below the map */
        .hospital-info {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 20px; /* More space between map and box */
            width: 90%;
            margin: 0 auto;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .hospital-info h2 {
            font-size: 22px;
            margin-bottom: 10px;
            color: #007BFF;
        }

        .hospital-info p {
            font-size: 15px;
            line-height: 1.6;
            color: #FFF; /* White text for better readability */
        }

        /* Light mode and dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1e1e1e;
                color: white;
            }

            .hospital-info {
                background-color: #2e2e2e;
                color: white;
            }

            .search-box,
            .suggestions {
                background-color: #3e3e3e;
                color: white;
            }

            .search-button {
                background-color: #444;
            }

            .search-button:hover {
                background-color: #666;
            }

            .clear-button {
                color: #ccc;
            }

            .suggestion {
                border-bottom: 1px solid #444;
            }

            .suggestion:hover {
                background-color: #555;
            }
        }
    </style>
</head>
<body>

    <!-- Search container -->
    <div class="search-container">
        <div class="search-box-wrapper">
            <input id="searchBox" class="search-box" type="text" placeholder="Search for hospitals..." oninput="showSuggestions()">
            <span id="clearBtn" class="clear-button" onclick="clearSearchBox()">&#10005;</span>
            <div id="suggestions" class="suggestions" style="display:none;"></div>
        </div>
        <button class="search-button" onclick="searchHospitals()">Search</button>
    </div>
    
    <!-- Map container -->
    <div id="map"></div>

    <!-- Hospital information section -->
    <div class="hospital-info" id="hospitalInfo" style="display: none;">
        <h2 id="hospitalTitle"></h2>
        <p id="hospitalDistance"></p> <!-- Distance first -->
        <p id="hospitalDescription"></p> <!-- Coordinates next -->
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        let userLat, userLng;
        let polyline;

        let map = L.map('map', {
            zoomControl: false, // Remove zoom control
            center: [23.6850, 90.3563], // Default center on Bangladesh
            zoom: 14
        });

        // Add custom dark and light mode tiles
        L.tileLayer('https://{s}.tile.jawg.io/jawg-light/{z}/{x}/{y}.png?access-token=z948v3fA4vRAvGxEZymUAlJLtd1AO4hh98wFWJmU4JUVvjdLGhd0bW1IOYZzm2ce', {
            attribution: '&copy; <a href="https://jawg.io">Jawg</a> contributors'
        }).addTo(map);

        // Automatically locate the user using the browser's geolocation API
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(position => {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;

                // Zoom to user's location and add red marker
                map.setView([userLat, userLng], 14);
                const userMarker = L.marker([userLat, userLng], {
                    icon: L.icon({
                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    })
                }).addTo(map).bindPopup('You are here').openPopup();

                // Fetch nearby hospitals from Overpass API
                fetchHospitals(userLat, userLng);
            }, () => {
                alert("Unable to retrieve your location.");
            });
        } else {
            alert("Geolocation is not supported by your browser.");
        }

        // Fetch nearby hospitals using OpenStreetMap's Overpass API
        function fetchHospitals(lat, lng) {
            const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node(around:5000,${lat},${lng})[amenity=hospital];out;`;

            fetch(overpassUrl)
                .then(response => response.json())
                .then(data => {
                    data.elements.forEach(hospital => {
                        const hospitalLat = hospital.lat;
                        const hospitalLng = hospital.lon;
                        const hospitalName = hospital.tags.name || "Unnamed Hospital";

                        // Calculate and display distance
                        const distance = calculateDistance(userLat, userLng, hospitalLat, hospitalLng).toFixed(2);

                        // Add marker for each hospital
                        const hospitalMarker = L.marker([hospitalLat, hospitalLng]).addTo(map);
                        hospitalMarker.on('click', function() {
                            // Show hospital info and calculate road distance
                            showHospitalInfo(hospitalName, hospitalLat, hospitalLng, distance);
                            drawRoute(userLat, userLng, hospitalLat, hospitalLng);
                        });

                        // Display distance in the map popup
                        hospitalMarker.bindPopup(`<b>${hospitalName}</b><br>Distance: ${distance} km`);
                    });
                })
                .catch(err => {
                    console.error("Error fetching hospitals:", err);
                });
        }

        // Function to calculate distance between two points in kilometers
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + 
                      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // Show selected hospital information and distance
        function showHospitalInfo(name, lat, lng, distance) {
            document.getElementById('hospitalTitle').innerText = name;
            document.getElementById('hospitalDistance').innerText = `Distance from your location: ${distance} km`;
            document.getElementById('hospitalDescription').innerText = `Coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            document.getElementById('hospitalInfo').style.display = 'block';
        }

        // Draw blue route line from user location to selected hospital
        function drawRoute(lat1, lon1, lat2, lon2) {
            if (polyline) {
                map.removeLayer(polyline);
            }

            polyline = L.polyline([[lat1, lon1], [lat2, lon2]], {color: 'blue'}).addTo(map);
        }

        // Show suggestions based on user input (mock data)
        const hospitals = [
            { name: 'Dhaka Medical College Hospital', lat: 23.7231, lng: 90.3958 },
            { name: 'Square Hospital', lat: 23.7526, lng: 90.3825 },
            { name: 'Apollo Hospital', lat: 23.8103, lng: 90.4125 },
        ];

        function showSuggestions() {
            const query = document.getElementById('searchBox').value.toLowerCase();
            const suggestionsBox = document.getElementById('suggestions');

            // Filter hospitals based on query
            const filteredHospitals = hospitals.filter(hospital => hospital.name.toLowerCase().includes(query));

            // Clear previous suggestions
            suggestionsBox.innerHTML = '';

            // Show suggestions
            if (filteredHospitals.length > 0 && query.length > 0) {
                suggestionsBox.style.display = 'block';
                filteredHospitals.forEach(hospital => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.classList.add('suggestion');
                    suggestionItem.textContent = hospital.name;
                    suggestionItem.onclick = function () {
                        document.getElementById('searchBox').value = hospital.name;
                        suggestionsBox.style.display = 'none';
                        zoomToHospital(hospital);
                    };
                    suggestionsBox.appendChild(suggestionItem);
                });
            } else {
                suggestionsBox.style.display = 'none';
            }
        }

        // Zoom to hospital location on the map
        function zoomToHospital(hospital) {
            map.setView([hospital.lat, hospital.lng], 15); // Zoom to the hospital
            L.marker([hospital.lat, hospital.lng]).addTo(map)
                .bindPopup(`<b>${hospital.name}</b><br>Hospital location.`)
                .openPopup();
        }

        // Clear the search box and hide suggestions
        function clearSearchBox() {
            document.getElementById('searchBox').value = '';
            document.getElementById('suggestions').style.display = 'none';
        }

        // Search hospitals based on user input
        function searchHospitals() {
            const query = document.getElementById('searchBox').value.toLowerCase();
            const filteredHospitals = hospitals.filter(hospital => hospital.name.toLowerCase().includes(query));
            
            if (filteredHospitals.length > 0) {
                zoomToHospital(filteredHospitals[0]);
            } else {
                alert("No hospitals found");
            }
        }
    </script>

</body>
</html>
